# Signal Lattice - рабочая инструкция проекта

## 1) Что это за проект

`Signal Lattice` — цифровой музыкальный инструмент, замаскированный под веб-интерфейс.

Это:
- не DAW
- не плагин
- не коммерческий продукт
- инструмент для исследования состояний и управления напряжением сигнала

Основной образ:
- полу-модульный синтезатор
- система наблюдения
- машина с собственной логикой

Ключевые ощущения:
- холод
- ритм
- напряжение
- контроль
- минимум эмоций, максимум сигнала

## 2) Исходные ограничения (зафиксировано)

- без скевоморфизма
- без музыкальных иконок
- без имитации реального железа
- максимум 2 цвета + черный
- один технический/моно шрифт
- элементы могут быть неудобными, но осмысленными

Текущая палитра:
- `#000000` — фон
- `#B8C2CC` — базовый сигнал/интерфейс
- `#00E5FF` — активность/критический сигнал

Шрифт:
- `JetBrains Mono`

## 3) С чего начали

Начали с концепта интерфейса как машины сигналов:
- `SOURCE BUS` (источники)
- `ROUTING FIELD 12x8` (матрица трасс)
- `CONSTRAINT CORE` (ограничения)
- `STATE TELEMETRY` (наблюдение и диагностика)

Затем сделали рабочий веб-прототип без сборки: `index.html + styles.css + app.js`.

## 4) Что уже сделано

### UI/композиция
- Верхняя строка состояния: `MODE`, `CLOCK`, `FAULT`, `AUDIO`
- Левый блок: входные потоки + регистры параметров
- Центр: матрица маршрутизации `12x8`
- Правый блок: ограничения и фиксация регистра
- Нижняя панель: `AMP`, `DENS`, `JITTER`, `CLIP`

### Логика матрицы
- Ячейки переключаются вручную
- Подсветка активных трактов в тактовом цикле
- Мутации зависят от `Mutation Seed`
- Добавлены режимы маршрутизации `A/B/C` с разной сигнальной логикой
- Добавлена snapshot-машина на 3 слота (`WRITE/RECALL/PURGE`)
- Добавлены fault-профили `00/11/21/31` с разным поведением матрицы и выхода
- Добавлен JSON export/import пакета snapshot-состояний
- Параметры влияют на расчет потока:
  - `Rate Divider`
  - `Phase Offset`
  - `Threshold Line`
  - `Limiter Window`
  - `Route Weight`
  - `Lock Register`

### Телеметрия
- Реальное обновление `IN / OUT / LOSS`
- Метрики наблюдения:
  - `AMP` (текущий/пик)
  - `DENS` (плотность активных ячеек)
  - `JITTER` (динамика изменения выхода)
  - `CLIP` (накопление перегруза)

### Аудио
- Подключен `Web Audio API`
- Инициализация после первого пользовательского действия (browser-safe)
- Цепочка:
  - 2 осциллятора
  - bandpass фильтр
  - master gain
- Параметры звука связаны с состоянием матрицы/телеметрии
- Для режимов `A/B/C` добавлен разный тип фильтра и разный маппинг частот/динамики
- Fault-профили влияют на аудио: фильтрацию, динамику и частотные отклонения
- Статус аудио:
  - `ARM` (ожидает действие пользователя)
  - `LIVE` (движок активен)
  - `N/A` (если `AudioContext` недоступен)

### Состояния и память
- Снимки состояния сохраняются в `localStorage`
- Snapshot включает:
  - матрицу `12x8`
  - значения всех регистров
  - текущий режим маршрутизации
  - состояние `Lock Register`
- Доступны операции:
  - экспорт всех 3 слотов в `.json`
  - импорт `.json` обратно в слоты

## 5) Текущая структура файлов

- `index.html` — разметка интерфейса инструмента
- `styles.css` — визуальный язык и адаптивная сетка
- `app.js` — логика матрицы, телеметрия, Web Audio API
- `PROJECT_INSTRUCTION.md` — этот документ

## 6) Что нужно сделать дальше

### Ближайший этап (следующий спринт)
1. Расширение fault-системы:
   - параметр интенсивности профиля
   - авто-переключение профилей по телеметрии
2. Доработка snapshot-пакета:
   - контроль версии схемы при импорте
   - частичный merge вместо полного замещения слотов

### После этого
1. Расширить аудиоцепь (добавить узлы окраски/пространства)
2. Ввести режим внешнего входа (микрофон/line-in через Web Audio)
3. Добавить экспорт/импорт состояний (JSON)

## 7) Правило продолжения работы

Перед каждым новым изменением:
1. Сверяться с этим документом и ограничениями из раздела 2.
2. Любую новую функцию добавлять так, чтобы она усиливала образ системы наблюдения/контроля, а не превращала инструмент в обычный UI.
3. Не выходить за палитру, типографику и логику сигнального минимализма.

## Update Log
- Added fault intensity control (`FAULT INTENSITY`) from 0..100.
- Added adaptive fault switching (`AUTO FAULT`) driven by telemetry pressure.
- Added `FAULT ACTUAL` readout to show effective profile after auto-resolution.
- Snapshot now stores/restores `faultIntensity` and `faultAuto`.
- Snapshot import now validates schema version (`signal-lattice-snapshot-pack-v1`).
- Added merge mode for import (`MERGE IMPORT`): preserve missing slots.
- Added replace mode for import (disable `MERGE IMPORT`): clear slots before import.
